<!doctype html>
<!--
 * Main HTML file interface for Modern.IE local scans. Prompts the user for a URL
 * to scan, sends the URL to the local service, and retrieves the JSON results.
 * The user can then submit the results to the Modern.IE site for a report.
 *
 * Copyright (c) Microsoft Corporation; All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this
 * file except in compliance with the License. You may obtain a copy of the License at
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * THIS CODE IS PROVIDED AS IS BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED WARRANTIES OR CONDITIONS
 * OF TITLE, FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABLITY OR NON-INFRINGEMENT.
 *
 * See the Apache Version 2.0 License for specific language governing permissions
 * and limitations under the License.
-->
<html>
<head>
    <title>Modern.ie Local Scan</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script>
        $(function () {
            $("#step2").hide();

            $("#scanform").on("submit", function (event) {
                var url = $("#url").val(),
					user = $("#user").val(),
					password = $("#password").val(),
					data;

                if (url.length < 4) {
                    alert("Please enter a URL.");
                    return false;
                }

                if (/^\/\//i.test(url)) {
                    url = "http:" + url;
                } else if (!/^http/i.test(url)) {
                    url = "http://" + url;
                }

                if (user && password) {
                    data = {
                        url: url,
                        user: user,
                        password: password
                    };
                } else {
                    data = {
                        url: url,
                        //deep: 'true'
                    };
                }

                event.preventDefault();
                $("#step1status").text("Scanning " + url + "...");

                var apiurl = $("#scanform").attr('action');

                $.ajax({
                    method: "get",
                    url: apiurl,
                    data: data,
                    dataType: "text"
                })
				.done(function (results) {
				    var resobj;
				    try {
				        resobj = JSON.parse(results);
				        delete resobj.url.auth;
				        results = JSON.stringify(resobj);
				    } catch (ex) {
				    }
				    $("#step1").hide();
				    $("#step1status").text("");
				    $("#step2").show();
				    $("#json").val(results);
				    $("#scanresults").hide().text(results);
				    try {
				        $("#scanresults").text(JSON.stringify(resobj, null, "  "));
				    } catch (ex) {
				    }
				})
				.fail(function (xhr) {
				    alert("Failed: " + xhr.status + " " + xhr.responseText);
				});
            });

            $("#newscan").on("click", function () {
                $("#step2").hide();
                $("#step1").show();
            });
            $("#viewresults").on("click", function () {
                $("#scanresults").show();
                $("#viewresults").hide();
                return false;
            });
        });
    </script>
</head>
<body>

    <h1>Modern.ie Local Scan</h1>

    <div id="step1">
	<h2>Scan a page (v2)</h2>

        <form id="scanform" action="/api/v1/scan">
            <label>URL to scan</label>
            <input type="text" name="url" id="url" size="70">
            <p>If the page requires authentication for access, enter below the username and password; otherwise leave the fields blank.</p>
            <p>HTTP Basic and Digest authentication methods are supported.</p>
            <label>Username</label>
            <input type="text" name="user" id="user" size="20">
            <label>Password</label>
            <input type="text" name="password" id="password" size="20">

            <input type="submit" name="scan" id="scan" value="Scan">
            <p id="step1status"></p>
        </form>
    </div>

    <div id="step2">
        <h2>Generate report</h2>

        <p>
            The scan is complete and the report is ready to be generated.
            Press the button below to submit the scan data to the Modern.ie site and create the report.
        </p>

        <form id="reportform" action="http://www.modern.ie/report/local" method="post">
            <input type="submit" id="report" value="Create Report">
            <input type="hidden" name="local_test_results" id="json" value="">
        </form>

        <p><a href="" id="viewresults">See what will be submitted</a></p>
        <pre id="scanresults"></pre>

        <div>
            <button id="newscan">New Scan</button>
        </div>
    </div>

</body>
</html>
